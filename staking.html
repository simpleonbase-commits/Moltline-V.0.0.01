<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAI Staking - Paper Hands Pay, Diamond Hands Gain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-gold: #f59e0b;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        }

        /* Security Banner */
        .security-banner {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.15));
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-green);
            font-weight: 500;
        }

        .security-badge.warning {
            color: var(--accent-gold);
        }

        .domain-display {
            background: rgba(16, 185, 129, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-green);
        }

        .verify-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .verify-link:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-text span {
            color: var(--accent-blue);
        }

        .official-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .connect-btn.connected {
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
        }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #fff, var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero .tagline {
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
        }

        .hero .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Contract Verification Box */
        .verification-box {
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .verification-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .verification-item .icon {
            font-size: 1.25rem;
        }

        .verification-item .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .verification-item a {
            color: var(--accent-green);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .verification-item a:hover {
            text-decoration: underline;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.gold { color: var(--accent-gold); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.red { color: var(--accent-red); }

        /* Main Panel */
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2rem;
            }
            .security-banner {
                font-size: 0.75rem;
            }
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-dark);
            padding: 0.25rem;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--accent-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        /* Input Group */
        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 1rem;
            padding-right: 5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-wrapper input:focus {
            border-color: var(--accent-blue);
        }

        .max-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(59, 130, 246, 0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--accent-blue);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .max-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Action Button */
        .action-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .warning-box.hidden {
            display: none;
        }

        .warning-icon {
            font-size: 1.25rem;
        }

        .warning-text {
            font-size: 0.9rem;
            color: var(--accent-red);
        }

        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
        }

        /* Position Card */
        .position-card {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .position-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .position-status {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .position-status.locked {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .position-status.unlocked {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .position-detail {
            text-align: center;
        }

        .position-detail-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .position-detail-value {
            font-weight: 600;
        }

        /* Token Info */
        .token-info {
            text-align: center;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-top: 1rem;
        }

        .token-info-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .token-address {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-blue);
            word-break: break-all;
        }

        /* Security Tips Box */
        .security-tips {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .security-tips-title {
            color: var(--accent-gold);
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .security-tips ul {
            margin: 0;
            padding-left: 1.25rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .security-tips li {
            margin-bottom: 0.5rem;
        }

        .security-tips li:last-child {
            margin-bottom: 0;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer-security {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .footer-security a {
            color: var(--accent-green);
        }

        /* Wallet Modal Styles */
        .wallet-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .wallet-modal-overlay.show {
            display: flex;
        }

        .wallet-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 420px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .wallet-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .wallet-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .wallet-modal-close:hover {
            color: var(--text-primary);
        }

        .wallet-security-notice {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.8rem;
            color: var(--accent-green);
            text-align: center;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            padding: 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            text-decoration: none;
        }

        .wallet-option:hover {
            border-color: var(--accent-blue);
            background: var(--bg-card-hover);
        }

        .wallet-option img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
        }

        .wallet-option-info {
            text-align: left;
            flex: 1;
        }

        .wallet-option-name {
            font-weight: 600;
        }

        .wallet-option-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .wallet-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .wallet-divider::before,
        .wallet-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .qr-container {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .qr-container canvas {
            max-width: 200px;
        }

        /* Mobile wallet links - Changed from <a> to <button> */
        .mobile-wallets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .mobile-wallet-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-wallet-btn:hover {
            border-color: var(--accent-blue);
            background: var(--bg-card-hover);
        }

        .mobile-wallet-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mobile-wallet-btn img {
            width: 36px;
            height: 36px;
            border-radius: 8px;
        }

        .copy-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .copy-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .copy-link-btn.copied {
            background: var(--accent-green);
        }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--accent-red);
            font-size: 0.9rem;
            text-align: center;
        }

        /* Network warning banner */
        .network-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: var(--accent-red);
        }

        .network-warning.show {
            display: flex;
        }

        .network-warning button {
            background: var(--accent-red);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-small {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Desktop-only elements */
        .desktop-only {
            display: block;
        }

        @media (max-width: 768px) {
            .desktop-only {
                display: none;
            }
        }

        /* Transaction Preview Modal */
        .tx-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .tx-preview-modal.show {
            display: flex;
        }

        .tx-preview-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 450px;
            width: 100%;
        }

        .tx-preview-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .tx-preview-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: var(--accent-gold);
        }

        .tx-preview-details {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tx-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .tx-detail-row:last-child {
            margin-bottom: 0;
        }

        .tx-detail-label {
            color: var(--text-secondary);
        }

        .tx-detail-value {
            font-weight: 600;
            font-family: monospace;
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }

        .tx-preview-buttons {
            display: flex;
            gap: 1rem;
        }

        .tx-preview-buttons button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .tx-cancel-btn {
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border-color) !important;
        }

        .tx-confirm-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }
    </style>
</head>
<body>
    <!-- Security Banner -->
    <div class="security-banner">
        <div class="security-badge">
            <span>üîí</span>
            <span>Official BAI Site</span>
        </div>
        <div class="domain-display" id="currentDomain">Loading...</div>
        <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank" class="verify-link">Verify Contract ‚Üí</a>
    </div>

    <div class="container">
        <!-- Network Warning Banner -->
        <div class="network-warning" id="networkWarning">
            <span>‚ö†Ô∏è Wrong network detected! Please switch to Base.</span>
            <button onclick="switchToBase()">Switch to Base</button>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üíé</div>
                <div class="logo-text">BAI <span>Staking</span></div>
                <span class="official-badge">‚úì OFFICIAL</span>
            </div>
            <button class="connect-btn" id="connectBtn" onclick="openWalletModal()">Connect Wallet</button>
        </header>

        <!-- Hero -->
        <section class="hero">
            <h1>üíé Paper Hands Pay, Diamond Hands Gain üíé</h1>
            <p class="tagline">Stake BAItest ‚Ä¢ Earn from early exits</p>
            <p class="subtitle">Lock for 7 days or pay 20% to those who wait</p>
        </section>

        <!-- Contract Verification Box -->
        <div class="verification-box">
            <div class="verification-item">
                <span class="icon">‚úÖ</span>
                <span class="label">Contract Verified:</span>
                <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank">BaseScan</a>
            </div>
            <div class="verification-item">
                <span class="icon">‚úÖ</span>
                <span class="label">Source Verified:</span>
                <a href="https://repo.sourcify.dev/contracts/full_match/8453/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc/" target="_blank">Sourcify</a>
            </div>
            <div class="verification-item">
                <span class="icon">üìÇ</span>
                <span class="label">Open Source:</span>
                <a href="https://github.com/simpleonbase-commits/BAI-V.0.0.01" target="_blank">GitHub</a>
            </div>
        </div>

        <!-- Stats -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Value Locked</div>
                <div class="stat-value blue" id="tvl">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lock Period</div>
                <div class="stat-value gold">7 Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Early Exit Penalty</div>
                <div class="stat-value red">20%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Your Rewards</div>
                <div class="stat-value green" id="rewards">0 BAItest</div>
            </div>
        </section>

        <!-- Main Panel -->
        <section class="main-panel">
            <!-- Left: Stake/Unstake -->
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('stake')">Stake</button>
                    <button class="tab" onclick="switchTab('unstake')">Unstake</button>
                    <button class="tab" onclick="switchTab('claim')">Claim</button>
                </div>

                <!-- Stake Tab -->
                <div id="stakeTab">
                    <div class="input-group">
                        <div class="input-label">
                            <span>Amount to Stake</span>
                            <span>Balance: <span id="walletBalance">0</span> BAItest</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="stakeAmount" placeholder="0.0">
                            <button class="max-btn" onclick="setMaxStake()">MAX</button>
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">Lock Period</span>
                            <span class="info-value">7 days</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Early Exit Penalty</span>
                            <span class="info-value">20%</span>
                        </div>
                    </div>
                    <button class="action-btn primary" id="stakeBtn" onclick="stake()">Stake BAItest</button>
                </div>

                <!-- Unstake Tab -->
                <div id="unstakeTab" style="display: none;">
                    <div class="warning-box" id="penaltyWarning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span class="warning-text">Your stake is still locked! Unstaking now will cost you <strong>20%</strong> penalty.</span>
                    </div>
                    <div class="input-group">
                        <div class="input-label">
                            <span>Amount to Unstake</span>
                            <span>Staked: <span id="stakedBalance">0</span> BAItest</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="unstakeAmount" placeholder="0.0">
                            <button class="max-btn" onclick="setMaxUnstake()">MAX</button>
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">You Will Receive</span>
                            <span class="info-value" id="receiveAmount">0 BAItest</span>
                        </div>
                        <div class="info-row" id="penaltyRow">
                            <span class="info-label">Penalty (20%)</span>
                            <span class="info-value" style="color: var(--accent-red)" id="penaltyAmount">0 BAItest</span>
                        </div>
                    </div>
                    <button class="action-btn danger" id="unstakeBtn" onclick="unstake()">Unstake BAItest</button>
                </div>

                <!-- Claim Tab -->
                <div id="claimTab" style="display: none;">
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">Claimable Rewards</span>
                            <span class="info-value" style="color: var(--accent-green)" id="claimableRewards">0 BAItest</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Source</span>
                            <span class="info-value">Paper hands penalties üßª</span>
                        </div>
                    </div>
                    <button class="action-btn primary" id="claimBtn" onclick="claimRewards()">Claim Rewards üí∞</button>
                </div>

                <div class="token-info">
                    <div class="token-info-label">BAItest Token Contract</div>
                    <div class="token-address">0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3</div>
                </div>
            </div>

            <!-- Right: Your Position -->
            <div class="panel">
                <h3 class="panel-title">üìä Your Position</h3>

                <div class="position-card">
                    <div class="position-header">
                        <span class="position-amount" id="yourStake">0 BAItest</span>
                        <span class="position-status locked" id="lockStatus">üîí Locked</span>
                    </div>
                    <div class="position-details">
                        <div class="position-detail">
                            <div class="position-detail-label">Unlock Time</div>
                            <div class="position-detail-value" id="unlockTime">--</div>
                        </div>
                        <div class="position-detail">
                            <div class="position-detail-label">Time Remaining</div>
                            <div class="position-detail-value" id="timeRemaining">--</div>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">Pending Rewards</span>
                        <span class="info-value" style="color: var(--accent-green)" id="pendingRewards">0 BAItest</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Share of Pool</span>
                        <span class="info-value" id="poolShare">0%</span>
                    </div>
                </div>

                <button class="action-btn primary" onclick="exitAll()" id="exitBtn">Exit All (Unstake + Claim)</button>

                <div class="token-info">
                    <div class="token-info-label">Staking Contract (Verified ‚úì)</div>
                    <div class="token-address">0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc</div>
                </div>

                <!-- Security Tips -->
                <div class="security-tips">
                    <div class="security-tips-title">üõ°Ô∏è Stay Safe</div>
                    <ul>
                        <li>Always verify you're on <strong>simpleonbase-commits.github.io</strong></li>
                        <li>Never share your seed phrase with anyone</li>
                        <li>Double-check contract addresses before signing</li>
                        <li>This contract is unaudited ‚Äî DYOR</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Part of the <a href="index.html">Bureau of Agent Investigations</a></p>
            <p style="margin-top: 0.5rem">Contract verified on <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank">BaseScan</a> & <a href="https://repo.sourcify.dev/contracts/full_match/8453/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc/" target="_blank">Sourcify</a></p>

            <div class="footer-security">
                <p><strong>üîí Security:</strong> Always verify you're on the official domain. Bookmark this page.</p>
                <p style="margin-top: 0.5rem">Official Domain: <a href="https://simpleonbase-commits.github.io/BAI-V.0.0.01/staking.html">simpleonbase-commits.github.io</a></p>
            </div>
        </footer>
    </div>

    <!-- Wallet Modal -->
    <div class="wallet-modal-overlay" id="walletModal">
        <div class="wallet-modal">
            <div class="wallet-modal-header">
                <span class="wallet-modal-title">Connect Wallet</span>
                <button class="wallet-modal-close" onclick="closeWalletModal()">&times;</button>
            </div>

            <!-- Security Notice in Modal -->
            <div class="wallet-security-notice">
                üîí You're connecting to the official BAI Staking site<br>
                <small>Domain: <span id="modalDomain">simpleonbase-commits.github.io</span></small>
            </div>

            <!-- Desktop wallet options -->
            <div id="desktopWallets">
                <button class="wallet-option" onclick="connectMetaMask()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
                    <div class="wallet-option-info">
                        <div class="wallet-option-name">MetaMask</div>
                        <div class="wallet-option-desc">Connect using browser extension</div>
                    </div>
                </button>

                <button class="wallet-option" onclick="connectCoinbase()">
                    <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.png" alt="Coinbase">
                    <div class="wallet-option-info">
                        <div class="wallet-option-name">Coinbase Wallet</div>
                        <div class="wallet-option-desc">Connect using Coinbase Wallet</div>
                    </div>
                </button>
            </div>

            <div class="wallet-divider">or connect from mobile</div>

            <!-- Error display -->
            <div id="wcError" class="error-box" style="display: none;"></div>

            <!-- Loading state -->
            <div id="wcLoading" style="text-align: center; padding: 2rem; display: none;">
                <div class="loading"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Generating connection link...</p>
            </div>

            <!-- QR Code and mobile options -->
            <div id="wcConnectSection">
                <div id="wcQrContainer" style="display: none;">
                    <div class="qr-container">
                        <canvas id="wcQrCode"></canvas>
                    </div>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Scan with any WalletConnect wallet</p>
                </div>

                <!-- Mobile wallet deep links - Now using buttons instead of anchors -->
                <div id="mobileWalletLinks" style="display: none;">
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">Open directly in your wallet app:</p>
                    <div class="mobile-wallets">
                        <button type="button" id="mmDeepLink" class="mobile-wallet-btn" onclick="openInMetaMask()">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
                            <span>MetaMask</span>
                        </button>
                        <button type="button" id="cbDeepLink" class="mobile-wallet-btn" onclick="openInCoinbase()">
                            <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.png" alt="Coinbase">
                            <span>Coinbase</span>
                        </button>
                        <button type="button" id="rbDeepLink" class="mobile-wallet-btn" onclick="openInRainbow()">
                            <img src="https://avatars.githubusercontent.com/u/48327834?s=200&v=4" alt="Rainbow">
                            <span>Rainbow</span>
                        </button>
                        <button type="button" id="twDeepLink" class="mobile-wallet-btn" onclick="openInTrust()">
                            <img src="https://trustwallet.com/assets/images/media/assets/trust_platform.svg" alt="Trust">
                            <span>Trust Wallet</span>
                        </button>
                    </div>
                </div>

                <!-- Copy link button -->
                <button class="copy-link-btn" id="copyLinkBtn" onclick="copyOrGenerateLink()">
                    <span id="copyBtnText">üìã Get Connection Link</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction Preview Modal -->
    <div class="tx-preview-modal" id="txPreviewModal">
        <div class="tx-preview-content">
            <div class="tx-preview-title" id="txPreviewTitle">Confirm Transaction</div>
            <div class="tx-preview-warning" id="txPreviewWarning"></div>
            <div class="tx-preview-details" id="txPreviewDetails"></div>
            <div class="tx-preview-buttons">
                <button class="tx-cancel-btn" onclick="closeTxPreview()">Cancel</button>
                <button class="tx-confirm-btn" id="txConfirmBtn" onclick="confirmTx()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // Set domain displays
        document.getElementById('currentDomain').textContent = window.location.hostname;
        document.getElementById('modalDomain').textContent = window.location.hostname;

        // Verify we're on the correct domain
        const OFFICIAL_DOMAINS = ['simpleonbase-commits.github.io', 'localhost', '127.0.0.1'];
        if (!OFFICIAL_DOMAINS.includes(window.location.hostname)) {
            document.querySelector('.security-banner').style.background = 'rgba(239, 68, 68, 0.2)';
            document.querySelector('.security-banner').style.borderColor = 'rgba(239, 68, 68, 0.5)';
            document.querySelector('.security-badge').innerHTML = '<span>‚ö†Ô∏è</span><span style="color: #ef4444">UNVERIFIED DOMAIN</span>';
            document.getElementById('currentDomain').style.background = 'rgba(239, 68, 68, 0.2)';
            document.getElementById('currentDomain').style.color = '#ef4444';
        }

        // Contract addresses
        const STAKING_CONTRACT = '0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc';
        const TOKEN_CONTRACT = '0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3';
        const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
        const BASE_CHAIN_ID_DECIMAL = 8453;
        const BASE_RPC_URL = 'https://mainnet.base.org';
        const WC_PROJECT_ID = '286e939deb1fd152d44312f068de95da';
        const LOCK_PERIOD_SECONDS = 604800; // 7 days in seconds

        // Contract ABIs (minimal)
        const STAKING_ABI = [
            'function stake(uint256 amount) external',
            'function unstake(uint256 amount) external',
            'function claimRewards() external',
            'function exit() external',
            'function stakes(address) view returns (uint256 amount, uint256 stakedAt, uint256 rewardPerTokenPaid, uint256 pendingRewards)',
            'function earned(address account) view returns (uint256)',
            'function isUnlocked(address account) view returns (bool)',
            'function unlockTime(address account) view returns (uint256)',
            'function totalStaked() view returns (uint256)',
            'function calculatePenalty(uint256 amount) view returns (uint256)'
        ];

        const TOKEN_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];

        // ============================================
        // STATE VARIABLES
        // ============================================
        
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let stakingContract = null;
        let tokenContract = null;
        let tokenDecimals = 18;
        let wcUri = null;
        let signClient = null;
        let pendingTxCallback = null;
        let isOnCorrectNetwork = false;
        let connectionType = null; // 'extension' or 'walletconnect'
        let isGeneratingLink = false; // Prevent multiple simultaneous link generations

        // ============================================
        // READ-ONLY PROVIDER FOR PUBLIC STATS (FIX #1)
        // ============================================
        
        // Create a read-only provider that works without wallet connection
        const readOnlyProvider = new ethers.JsonRpcProvider(BASE_RPC_URL);
        const readOnlyStakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, readOnlyProvider);
        const readOnlyTokenContract = new ethers.Contract(TOKEN_CONTRACT, TOKEN_ABI, readOnlyProvider);

        // Fetch public stats on page load (no wallet needed!)
        async function fetchPublicStats() {
            try {
                console.log('[Stats] Fetching public stats...');
                const totalStaked = await readOnlyStakingContract.totalStaked();
                const tvlFormatted = ethers.formatUnits(totalStaked, 18);
                document.getElementById('tvl').textContent = parseFloat(tvlFormatted).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' BAItest';
                console.log('[Stats] TVL loaded:', tvlFormatted);
            } catch (error) {
                console.error('[Stats] Error fetching public stats:', error);
                document.getElementById('tvl').textContent = 'Error loading';
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function showError(message) {
            const errorBox = document.getElementById('wcError');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }

        function hideError() {
            document.getElementById('wcError').style.display = 'none';
        }

        // ============================================
        // NETWORK HANDLING (FIX #2)
        // ============================================
        
        async function checkNetwork() {
            if (!window.ethereum) return false;
            
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const isBase = chainId === BASE_CHAIN_ID;
                
                document.getElementById('networkWarning').classList.toggle('show', !isBase);
                isOnCorrectNetwork = isBase;
                
                console.log('[Network] Current chain:', chainId, 'Is Base:', isBase);
                return isBase;
            } catch (error) {
                console.error('[Network] Error checking network:', error);
                return false;
            }
        }

        async function switchToBase() {
            if (!window.ethereum) {
                alert('No wallet detected');
                return;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_CHAIN_ID }],
                });
                await checkNetwork();
                await updateUI();
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: [BASE_RPC_URL],
                                blockExplorerUrls: ['https://basescan.org']
                            }],
                        });
                        await checkNetwork();
                        await updateUI();
                    } catch (addError) {
                        console.error('[Network] Error adding Base network:', addError);
                        alert('Failed to add Base network: ' + addError.message);
                    }
                } else {
                    console.error('[Network] Error switching network:', switchError);
                    alert('Failed to switch network: ' + switchError.message);
                }
            }
        }

        // ============================================
        // WALLET CONNECTION - BROWSER EXTENSION (FIX #3)
        // ============================================
        
        async function connectMetaMask() {
            console.log('[Wallet] Attempting MetaMask connection...');
            
            if (typeof window.ethereum === 'undefined') {
                console.log('[Wallet] No ethereum provider detected');
                if (isMobile()) {
                    await generateWalletConnectLink();
                    openInMetaMask();
                    return;
                }
                alert('MetaMask is not installed. Please install it from metamask.io');
                return;
            }

            try {
                // Request accounts
                console.log('[Wallet] Requesting accounts...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('[Wallet] Accounts received:', accounts);

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts returned');
                }

                // Switch to Base network
                console.log('[Wallet] Switching to Base network...');
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    console.log('[Wallet] Switch error:', switchError);
                    if (switchError.code === 4902) {
                        console.log('[Wallet] Adding Base network...');
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: [BASE_RPC_URL],
                                blockExplorerUrls: ['https://basescan.org']
                            }],
                        });
                    } else if (switchError.code !== 4001) { // 4001 = user rejected
                        throw switchError;
                    }
                }

                // Set connection state
                currentAccount = accounts[0];
                connectionType = 'extension';
                console.log('[Wallet] Connected account:', currentAccount);

                // Initialize contracts
                await initContracts();
                
                // Close modal and update UI
                closeWalletModal();
                await updateUI();

            } catch (error) {
                console.error('[Wallet] MetaMask connection error:', error);
                showError('Connection failed: ' + (error.message || 'Unknown error'));
            }
        }

        async function connectCoinbase() {
            // Coinbase Wallet also injects window.ethereum
            if (typeof window.ethereum === 'undefined') {
                if (isMobile()) {
                    await generateWalletConnectLink();
                    openInCoinbase();
                    return;
                }
                alert('No wallet detected. Please install Coinbase Wallet.');
                return;
            }
            await connectMetaMask();
        }

        // ============================================
        // CONTRACT INITIALIZATION (FIX #4)
        // ============================================
        
        async function initContracts() {
            console.log('[Contracts] Initializing...');
            
            if (connectionType === 'extension') {
                if (!window.ethereum) {
                    console.error('[Contracts] No ethereum provider');
                    return false;
                }

                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    console.log('[Contracts] Got signer:', await signer.getAddress());

                    stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                    tokenContract = new ethers.Contract(TOKEN_CONTRACT, TOKEN_ABI, signer);

                    try {
                        tokenDecimals = await tokenContract.decimals();
                    } catch {
                        tokenDecimals = 18;
                    }

                    console.log('[Contracts] Initialized successfully');
                    return true;
                } catch (error) {
                    console.error('[Contracts] Initialization error:', error);
                    return false;
                }
            } else if (connectionType === 'walletconnect') {
                // WalletConnect uses read-only provider for reads, 
                // but needs special handling for writes
                // For now, use read-only for all reads
                stakingContract = readOnlyStakingContract;
                tokenContract = readOnlyTokenContract;
                return true;
            }
            
            return false;
        }

        // ============================================
        // UI UPDATE (FIX #5 - SEPARATED PUBLIC & USER STATS)
        // ============================================
        
        async function updateUI() {
            const connectBtn = document.getElementById('connectBtn');

            // ALWAYS fetch public stats (TVL) first
            await fetchPublicStats();

            // If no wallet connected, show defaults for user-specific data
            if (!currentAccount) {
                console.log('[UI] No account connected, showing defaults');
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.classList.remove('connected');
                document.getElementById('walletBalance').textContent = '0';
                document.getElementById('stakedBalance').textContent = '0';
                document.getElementById('yourStake').textContent = '0 BAItest';
                document.getElementById('rewards').textContent = '0 BAItest';
                document.getElementById('pendingRewards').textContent = '0 BAItest';
                document.getElementById('claimableRewards').textContent = '0 BAItest';
                document.getElementById('lockStatus').textContent = 'Connect wallet';
                document.getElementById('lockStatus').className = 'position-status';
                document.getElementById('unlockTime').textContent = '--';
                document.getElementById('timeRemaining').textContent = '--';
                document.getElementById('poolShare').textContent = '0%';
                return;
            }

            // Update button to show connected state
            const shortAddr = currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
            connectBtn.textContent = shortAddr + ' ‚úì';
            connectBtn.classList.add('connected');

            // Check network
            if (connectionType === 'extension') {
                const onBase = await checkNetwork();
                if (!onBase) {
                    console.log('[UI] Wrong network, skipping user stats');
                    return;
                }
            }

            // Initialize contracts if needed
            if (!stakingContract || !tokenContract) {
                const success = await initContracts();
                if (!success) {
                    console.error('[UI] Failed to initialize contracts');
                    return;
                }
            }

            // Fetch user-specific data with better error handling
            let stakeInfo = null;
            let stakedAmount = '0';
            let stakedAtTimestamp = 0;
            let totalStakedValue = 0;

            // Step 1: Fetch basic balance and stake info
            try {
                console.log('[UI] Fetching user data for:', currentAccount);

                // Token balance
                const tokenBalance = await readOnlyTokenContract.balanceOf(currentAccount);
                const formattedBalance = ethers.formatUnits(tokenBalance, tokenDecimals);
                document.getElementById('walletBalance').textContent = parseFloat(formattedBalance).toFixed(2);

                // Stake info - this returns (amount, stakedAt, rewardPerTokenPaid, pendingRewards)
                stakeInfo = await readOnlyStakingContract.stakes(currentAccount);
                console.log('[UI] Stake info raw:', stakeInfo);
                
                stakedAmount = ethers.formatUnits(stakeInfo[0], tokenDecimals); // stakeInfo.amount or stakeInfo[0]
                stakedAtTimestamp = Number(stakeInfo[1]); // stakeInfo.stakedAt or stakeInfo[1]
                
                document.getElementById('stakedBalance').textContent = parseFloat(stakedAmount).toFixed(2);
                document.getElementById('yourStake').textContent = parseFloat(stakedAmount).toFixed(2) + ' BAItest';

                console.log('[UI] Staked amount:', stakedAmount, 'Staked at:', stakedAtTimestamp);

            } catch (error) {
                console.error('[UI] Error fetching basic user data:', error);
            }

            // Step 2: Fetch rewards (separate try/catch)
            try {
                const earned = await readOnlyStakingContract.earned(currentAccount);
                const earnedFormatted = ethers.formatUnits(earned, tokenDecimals);
                document.getElementById('rewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
                document.getElementById('pendingRewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
                document.getElementById('claimableRewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
            } catch (error) {
                console.error('[UI] Error fetching rewards:', error);
            }

            // Step 3: Calculate pool share (separate try/catch)
            try {
                const totalStaked = await readOnlyStakingContract.totalStaked();
                totalStakedValue = parseFloat(ethers.formatUnits(totalStaked, tokenDecimals));

                if (totalStakedValue > 0 && parseFloat(stakedAmount) > 0) {
                    const share = (parseFloat(stakedAmount) / totalStakedValue * 100).toFixed(2);
                    document.getElementById('poolShare').textContent = share + '%';
                } else {
                    document.getElementById('poolShare').textContent = '0%';
                }
            } catch (error) {
                console.error('[UI] Error calculating pool share:', error);
            }

            // Step 4: Lock status and unlock time (CRITICAL FIX - use stakedAt directly)
            try {
                const stakedAmountNum = parseFloat(stakedAmount);
                
                if (stakedAmountNum === 0 || stakedAtTimestamp === 0) {
                    // No stake
                    document.getElementById('lockStatus').textContent = 'No Stake';
                    document.getElementById('lockStatus').className = 'position-status';
                    document.getElementById('unlockTime').textContent = '--';
                    document.getElementById('timeRemaining').textContent = '--';
                    document.getElementById('penaltyWarning').classList.add('hidden');
                    console.log('[UI] No stake detected');
                } else {
                    // Calculate unlock time from stakedAt + lockPeriod
                    const unlockTimestamp = stakedAtTimestamp + LOCK_PERIOD_SECONDS;
                    const currentTimestamp = Math.floor(Date.now() / 1000);
                    const isUnlocked = currentTimestamp >= unlockTimestamp;

                    console.log('[UI] Lock calculation:', {
                        stakedAt: stakedAtTimestamp,
                        unlockAt: unlockTimestamp,
                        current: currentTimestamp,
                        isUnlocked: isUnlocked
                    });

                    if (isUnlocked) {
                        document.getElementById('lockStatus').textContent = 'üîì Unlocked';
                        document.getElementById('lockStatus').className = 'position-status unlocked';
                        document.getElementById('unlockTime').textContent = 'Now';
                        document.getElementById('timeRemaining').textContent = 'Ready!';
                        document.getElementById('penaltyWarning').classList.add('hidden');
                    } else {
                        document.getElementById('lockStatus').textContent = 'üîí Locked';
                        document.getElementById('lockStatus').className = 'position-status locked';
                        
                        // Format unlock date
                        const unlockDate = new Date(unlockTimestamp * 1000);
                        document.getElementById('unlockTime').textContent = unlockDate.toLocaleDateString();

                        // Calculate time remaining
                        const remaining = unlockTimestamp - currentTimestamp;
                        const days = Math.floor(remaining / 86400);
                        const hours = Math.floor((remaining % 86400) / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        
                        if (days > 0) {
                            document.getElementById('timeRemaining').textContent = days + 'd ' + hours + 'h';
                        } else if (hours > 0) {
                            document.getElementById('timeRemaining').textContent = hours + 'h ' + minutes + 'm';
                        } else {
                            document.getElementById('timeRemaining').textContent = minutes + ' min';
                        }
                        
                        document.getElementById('penaltyWarning').classList.remove('hidden');
                    }
                }

                console.log('[UI] User data loaded successfully');

            } catch (error) {
                console.error('[UI] Error calculating lock status:', error);
                // Fallback: try to use contract's isUnlocked and unlockTime functions
                try {
                    const isUnlocked = await readOnlyStakingContract.isUnlocked(currentAccount);
                    const unlockTimestamp = await readOnlyStakingContract.unlockTime(currentAccount);
                    
                    if (parseFloat(stakedAmount) === 0) {
                        document.getElementById('lockStatus').textContent = 'No Stake';
                        document.getElementById('lockStatus').className = 'position-status';
                        document.getElementById('unlockTime').textContent = '--';
                        document.getElementById('timeRemaining').textContent = '--';
                        document.getElementById('penaltyWarning').classList.add('hidden');
                    } else if (isUnlocked) {
                        document.getElementById('lockStatus').textContent = 'üîì Unlocked';
                        document.getElementById('lockStatus').className = 'position-status unlocked';
                        document.getElementById('unlockTime').textContent = 'Now';
                        document.getElementById('timeRemaining').textContent = 'Ready!';
                        document.getElementById('penaltyWarning').classList.add('hidden');
                    } else {
                        document.getElementById('lockStatus').textContent = 'üîí Locked';
                        document.getElementById('lockStatus').className = 'position-status locked';
                        const unlockDate = new Date(Number(unlockTimestamp) * 1000);
                        document.getElementById('unlockTime').textContent = unlockDate.toLocaleDateString();
                        const remaining = Number(unlockTimestamp) - Math.floor(Date.now() / 1000);
                        const days = Math.floor(remaining / 86400);
                        const hours = Math.floor((remaining % 86400) / 3600);
                        document.getElementById('timeRemaining').textContent = days + 'd ' + hours + 'h';
                        document.getElementById('penaltyWarning').classList.remove('hidden');
                    }
                } catch (fallbackError) {
                    console.error('[UI] Fallback lock status also failed:', fallbackError);
                }
            }
        }

        // ============================================
        // TRANSACTION PREVIEW MODAL
        // ============================================
        
        function showTxPreview(title, warning, details, callback) {
            document.getElementById('txPreviewTitle').textContent = title;
            document.getElementById('txPreviewWarning').innerHTML = warning;

            let detailsHtml = '';
            for (const [label, value] of Object.entries(details)) {
                detailsHtml += `<div class="tx-detail-row"><span class="tx-detail-label">${label}</span><span class="tx-detail-value">${value}</span></div>`;
            }
            document.getElementById('txPreviewDetails').innerHTML = detailsHtml;

            pendingTxCallback = callback;
            document.getElementById('txPreviewModal').classList.add('show');
        }

        function closeTxPreview() {
            document.getElementById('txPreviewModal').classList.remove('show');
            pendingTxCallback = null;
        }

        // FIX: Save callback before closing modal (was being cleared before execution)
        function confirmTx() {
            const callback = pendingTxCallback;  // Save callback before closing
            closeTxPreview();  // This clears pendingTxCallback
            if (callback) {
                console.log('[TX] Executing confirmed transaction callback...');
                callback();
            } else {
                console.error('[TX] No callback to execute!');
            }
        }

        // ============================================
        // WALLET MODAL
        // ============================================
        
        function openWalletModal() {
            if (currentAccount) {
                disconnectWallet();
                return;
            }
            document.getElementById('walletModal').classList.add('show');
            resetModalState();

            // Auto-generate link on mobile
            if (isMobile()) {
                generateWalletConnectLink();
            }
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('show');
        }

        function resetModalState() {
            document.getElementById('wcLoading').style.display = 'none';
            document.getElementById('wcQrContainer').style.display = 'none';
            document.getElementById('mobileWalletLinks').style.display = 'none';
            hideError();
            document.getElementById('copyBtnText').textContent = 'üìã Get Connection Link';
            document.getElementById('copyLinkBtn').classList.remove('copied');
            wcUri = null;
            isGeneratingLink = false;
            
            // Reset button states
            const walletBtns = document.querySelectorAll('.mobile-wallet-btn');
            walletBtns.forEach(btn => {
                btn.disabled = false;
                const span = btn.querySelector('span');
                if (span && span.dataset.originalText) {
                    span.textContent = span.dataset.originalText;
                }
            });
        }

        // Click outside to close
        document.getElementById('walletModal').addEventListener('click', function(e) {
            if (e.target === this) closeWalletModal();
        });

        document.getElementById('txPreviewModal').addEventListener('click', function(e) {
            if (e.target === this) closeTxPreview();
        });

        function disconnectWallet() {
            currentAccount = null;
            provider = null;
            signer = null;
            stakingContract = null;
            tokenContract = null;
            connectionType = null;
            document.getElementById('networkWarning').classList.remove('show');
            updateUI();
        }

        // ============================================
        // WALLETCONNECT (MOBILE)
        // ============================================
        
        async function generateWalletConnectLink() {
            // Prevent multiple simultaneous generations
            if (isGeneratingLink) {
                console.log('[WC] Already generating link, skipping...');
                return wcUri; // Return existing URI if available
            }
            
            isGeneratingLink = true;
            const loading = document.getElementById('wcLoading');
            const qrContainer = document.getElementById('wcQrContainer');
            const mobileLinks = document.getElementById('mobileWalletLinks');

            loading.style.display = 'block';
            hideError();

            try {
                const { Core } = await import('https://esm.sh/@walletconnect/core@2.11.0');
                const SignClient = (await import('https://esm.sh/@walletconnect/sign-client@2.11.0')).default;

                if (!signClient) {
                    signClient = await SignClient.init({
                        projectId: WC_PROJECT_ID,
                        metadata: {
                            name: 'BAI Staking',
                            description: 'Paper Hands Pay, Diamond Hands Gain',
                            url: window.location.origin,
                            icons: ['https://simpleonbase-commits.github.io/BAI-V.0.0.01/favicon.ico']
                        }
                    });

                    signClient.on('session_delete', () => {
                        currentAccount = null;
                        connectionType = null;
                        updateUI();
                    });
                }

                const { uri, approval } = await signClient.connect({
                    requiredNamespaces: {
                        eip155: {
                            methods: ['eth_sendTransaction', 'personal_sign', 'eth_signTypedData'],
                            chains: ['eip155:8453'],
                            events: ['chainChanged', 'accountsChanged']
                        }
                    }
                });

                wcUri = uri;
                loading.style.display = 'none';
                isGeneratingLink = false;

                // Show QR on desktop
                if (!isMobile()) {
                    qrContainer.style.display = 'block';
                    const canvas = document.getElementById('wcQrCode');
                    await QRCode.toCanvas(canvas, uri, {
                        width: 200,
                        margin: 2,
                        color: { dark: '#000000', light: '#ffffff' }
                    });
                }

                mobileLinks.style.display = 'block';
                document.getElementById('copyBtnText').textContent = 'üìã Copy Connection Link';

                // Wait for approval (non-blocking for the return)
                approval().then(session => {
                    const accounts = session.namespaces.eip155.accounts;
                    const address = accounts[0].split(':')[2];

                    currentAccount = address;
                    connectionType = 'walletconnect';
                    window.wcSession = session;
                    closeWalletModal();
                    updateUI();
                }).catch(err => {
                    console.log('[WC] Approval error or user rejected:', err);
                });
                
                return wcUri;

            } catch (error) {
                console.error('WalletConnect error:', error);
                loading.style.display = 'none';
                isGeneratingLink = false;

                if (error.message && !error.message.includes('rejected')) {
                    showError('Connection error: ' + error.message);
                    mobileLinks.style.display = 'block';
                }
                return null;
            }
        }

        async function copyOrGenerateLink() {
            if (!wcUri) {
                await generateWalletConnectLink();
                return;
            }

            try {
                await navigator.clipboard.writeText(wcUri);
                const btn = document.getElementById('copyLinkBtn');
                const btnText = document.getElementById('copyBtnText');
                btn.classList.add('copied');
                btnText.textContent = '‚úì Copied! Paste in wallet app';

                setTimeout(() => {
                    btn.classList.remove('copied');
                    btnText.textContent = 'üìã Copy Connection Link';
                }, 3000);
            } catch (err) {
                prompt('Copy this link and paste in your wallet:', wcUri);
            }
        }

        // FIX: Mobile wallet buttons - ensure link exists before opening
        async function openInMetaMask() {
            const btn = document.getElementById('mmDeepLink');
            const span = btn.querySelector('span');
            
            // Store original text
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.textContent;
            }
            
            if (!wcUri) {
                console.log('[WC] No URI yet, generating for MetaMask...');
                btn.disabled = true;
                span.textContent = 'Connecting...';
                
                const uri = await generateWalletConnectLink();
                
                btn.disabled = false;
                span.textContent = span.dataset.originalText;
                
                if (!uri) {
                    console.error('[WC] Failed to generate link for MetaMask');
                    return;
                }
            }
            
            console.log('[WC] Opening MetaMask with URI');
            const encoded = encodeURIComponent(wcUri);
            window.location.href = `metamask://wc?uri=${encoded}`;
        }

        async function openInCoinbase() {
            const btn = document.getElementById('cbDeepLink');
            const span = btn.querySelector('span');
            
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.textContent;
            }
            
            if (!wcUri) {
                console.log('[WC] No URI yet, generating for Coinbase...');
                btn.disabled = true;
                span.textContent = 'Connecting...';
                
                const uri = await generateWalletConnectLink();
                
                btn.disabled = false;
                span.textContent = span.dataset.originalText;
                
                if (!uri) {
                    console.error('[WC] Failed to generate link for Coinbase');
                    return;
                }
            }
            
            console.log('[WC] Opening Coinbase with URI');
            const encoded = encodeURIComponent(wcUri);
            window.location.href = `cbwallet://wc?uri=${encoded}`;
        }

        async function openInRainbow() {
            const btn = document.getElementById('rbDeepLink');
            const span = btn.querySelector('span');
            
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.textContent;
            }
            
            if (!wcUri) {
                console.log('[WC] No URI yet, generating for Rainbow...');
                btn.disabled = true;
                span.textContent = 'Connecting...';
                
                const uri = await generateWalletConnectLink();
                
                btn.disabled = false;
                span.textContent = span.dataset.originalText;
                
                if (!uri) {
                    console.error('[WC] Failed to generate link for Rainbow');
                    return;
                }
            }
            
            console.log('[WC] Opening Rainbow with URI');
            const encoded = encodeURIComponent(wcUri);
            window.location.href = `rainbow://wc?uri=${encoded}`;
        }

        async function openInTrust() {
            const btn = document.getElementById('twDeepLink');
            const span = btn.querySelector('span');
            
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.textContent;
            }
            
            if (!wcUri) {
                console.log('[WC] No URI yet, generating for Trust...');
                btn.disabled = true;
                span.textContent = 'Connecting...';
                
                const uri = await generateWalletConnectLink();
                
                btn.disabled = false;
                span.textContent = span.dataset.originalText;
                
                if (!uri) {
                    console.error('[WC] Failed to generate link for Trust');
                    return;
                }
            }
            
            console.log('[WC] Opening Trust with URI');
            const encoded = encodeURIComponent(wcUri);
            window.location.href = `trust://wc?uri=${encoded}`;
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[['stake', 'unstake', 'claim'].indexOf(tab)].classList.add('active');

            document.getElementById('stakeTab').style.display = tab === 'stake' ? 'block' : 'none';
            document.getElementById('unstakeTab').style.display = tab === 'unstake' ? 'block' : 'none';
            document.getElementById('claimTab').style.display = tab === 'claim' ? 'block' : 'none';
        }

        // ============================================
        // STAKING ACTIONS
        // ============================================
        
        function setMaxStake() {
            const balance = document.getElementById('walletBalance').textContent;
            document.getElementById('stakeAmount').value = balance;
        }

        function setMaxUnstake() {
            const staked = document.getElementById('stakedBalance').textContent;
            document.getElementById('unstakeAmount').value = staked;
            updateUnstakePreview();
        }

        document.getElementById('unstakeAmount').addEventListener('input', updateUnstakePreview);

        async function updateUnstakePreview() {
            const amount = document.getElementById('unstakeAmount').value || 0;
            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');

            if (isUnlocked) {
                document.getElementById('receiveAmount').textContent = parseFloat(amount).toFixed(4) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = '0 BAItest';
                document.getElementById('penaltyRow').style.display = 'none';
            } else {
                const penalty = parseFloat(amount) * 0.20;
                const receive = parseFloat(amount) - penalty;
                document.getElementById('receiveAmount').textContent = receive.toFixed(4) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = penalty.toFixed(4) + ' BAItest';
                document.getElementById('penaltyRow').style.display = 'flex';
            }
        }

        async function stake() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }

            const amount = document.getElementById('stakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter an amount to stake');
                return;
            }

            showTxPreview(
                'üîí Confirm Stake',
                '‚ö†Ô∏è <strong>Important:</strong> Your tokens will be locked for 7 days. Early withdrawal incurs a 20% penalty.',
                {
                    'Amount': amount + ' BAItest',
                    'Lock Period': '7 days',
                    'Contract': STAKING_CONTRACT.slice(0, 10) + '...' + STAKING_CONTRACT.slice(-8)
                },
                executeStake
            );
        }

        async function executeStake() {
            console.log('[Stake] executeStake called');
            const amount = document.getElementById('stakeAmount').value;
            const btn = document.getElementById('stakeBtn');
            const originalText = btn.textContent;

            console.log('[Stake] Amount:', amount, 'ConnectionType:', connectionType);

            try {
                // Re-initialize contracts with signer for writes
                if (connectionType === 'extension') {
                    console.log('[Stake] Re-initializing contracts with signer...');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                    tokenContract = new ethers.Contract(TOKEN_CONTRACT, TOKEN_ABI, signer);
                    console.log('[Stake] Contracts initialized');
                } else {
                    console.error('[Stake] Unsupported connection type:', connectionType);
                    alert('Please connect with MetaMask browser extension to stake.');
                    return;
                }

                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                console.log('[Stake] Amount in wei:', amountWei.toString());

                btn.textContent = 'Checking allowance...';
                console.log('[Stake] Checking allowance...');
                const allowance = await tokenContract.allowance(currentAccount, STAKING_CONTRACT);
                console.log('[Stake] Current allowance:', allowance.toString());

                if (allowance < amountWei) {
                    btn.textContent = 'Approving...';
                    console.log('[Stake] Requesting approval...');
                    const approveTx = await tokenContract.approve(STAKING_CONTRACT, amountWei);
                    console.log('[Stake] Approval tx sent:', approveTx.hash);
                    await approveTx.wait();
                    console.log('[Stake] Approval confirmed');
                }

                btn.textContent = 'Staking...';
                console.log('[Stake] Calling stake function...');
                const stakeTx = await stakingContract.stake(amountWei);
                console.log('[Stake] Stake tx sent:', stakeTx.hash);
                await stakeTx.wait();
                console.log('[Stake] Stake confirmed!');

                btn.textContent = 'Staked! ‚úì';
                document.getElementById('stakeAmount').value = '';
                await updateUI();

                setTimeout(() => { btn.textContent = originalText; }, 2000);

            } catch (error) {
                console.error('[Stake] Error:', error);
                btn.textContent = originalText;
                alert('Stake failed: ' + (error.reason || error.message));
            }
        }

        async function unstake() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }

            const amount = document.getElementById('unstakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter an amount to unstake');
                return;
            }

            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');
            const penalty = isUnlocked ? 0 : parseFloat(amount) * 0.20;
            const receive = parseFloat(amount) - penalty;

            showTxPreview(
                isUnlocked ? 'üîì Confirm Unstake' : '‚ö†Ô∏è Early Unstake Warning',
                isUnlocked
                    ? '‚úÖ Your lock period has ended. You can unstake without penalty.'
                    : 'üö® <strong>PENALTY WARNING:</strong> Your stake is still locked! You will lose <strong>20%</strong> of your tokens as a penalty. This penalty goes to other stakers.',
                {
                    'Unstake Amount': amount + ' BAItest',
                    'Penalty': penalty.toFixed(4) + ' BAItest',
                    'You Receive': receive.toFixed(4) + ' BAItest',
                    'Contract': STAKING_CONTRACT.slice(0, 10) + '...' + STAKING_CONTRACT.slice(-8)
                },
                executeUnstake
            );
        }

        async function executeUnstake() {
            console.log('[Unstake] executeUnstake called');
            const amount = document.getElementById('unstakeAmount').value;
            const btn = document.getElementById('unstakeBtn');
            const originalText = btn.textContent;

            try {
                if (connectionType === 'extension') {
                    console.log('[Unstake] Re-initializing contracts with signer...');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                } else {
                    alert('Please connect with MetaMask browser extension to unstake.');
                    return;
                }

                btn.textContent = 'Unstaking...';
                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                console.log('[Unstake] Calling unstake with amount:', amountWei.toString());
                const tx = await stakingContract.unstake(amountWei);
                console.log('[Unstake] Tx sent:', tx.hash);
                await tx.wait();
                console.log('[Unstake] Confirmed!');

                btn.textContent = 'Unstaked! ‚úì';
                document.getElementById('unstakeAmount').value = '';
                await updateUI();

                setTimeout(() => { btn.textContent = originalText; }, 2000);

            } catch (error) {
                console.error('[Unstake] Error:', error);
                btn.textContent = originalText;
                alert('Unstake failed: ' + (error.reason || error.message));
            }
        }

        async function claimRewards() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }

            const rewards = document.getElementById('claimableRewards').textContent;

            showTxPreview(
                'üí∞ Claim Rewards',
                '‚úÖ Claim your earned rewards from paper hands penalties.',
                {
                    'Rewards': rewards,
                    'Source': 'Early exit penalties',
                    'Contract': STAKING_CONTRACT.slice(0, 10) + '...' + STAKING_CONTRACT.slice(-8)
                },
                executeClaimRewards
            );
        }

        async function executeClaimRewards() {
            console.log('[Claim] executeClaimRewards called');
            const btn = document.getElementById('claimBtn');
            const originalText = btn.textContent;

            try {
                if (connectionType === 'extension') {
                    console.log('[Claim] Re-initializing contracts with signer...');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                } else {
                    alert('Please connect with MetaMask browser extension to claim.');
                    return;
                }

                btn.textContent = 'Claiming...';
                console.log('[Claim] Calling claimRewards...');
                const tx = await stakingContract.claimRewards();
                console.log('[Claim] Tx sent:', tx.hash);
                await tx.wait();
                console.log('[Claim] Confirmed!');

                btn.textContent = 'Claimed! ‚úì';
                await updateUI();

                setTimeout(() => { btn.textContent = originalText; }, 2000);

            } catch (error) {
                console.error('[Claim] Error:', error);
                btn.textContent = originalText;
                alert('Claim failed: ' + (error.reason || error.message));
            }
        }

        async function exitAll() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }

            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');
            const stakedAmount = document.getElementById('stakedBalance').textContent;
            const rewards = document.getElementById('claimableRewards').textContent;
            const penalty = isUnlocked ? 0 : parseFloat(stakedAmount) * 0.20;
            const receive = parseFloat(stakedAmount) - penalty;

            showTxPreview(
                isUnlocked ? 'üöÄ Exit All' : '‚ö†Ô∏è Exit All (With Penalty)',
                isUnlocked
                    ? '‚úÖ Unstake all tokens and claim rewards in one transaction.'
                    : 'üö® <strong>PENALTY WARNING:</strong> Your stake is locked! Exiting now costs 20% penalty.',
                {
                    'Staked': stakedAmount + ' BAItest',
                    'Penalty': penalty.toFixed(4) + ' BAItest',
                    'Tokens Received': receive.toFixed(4) + ' BAItest',
                    'Rewards': rewards,
                    'Contract': STAKING_CONTRACT.slice(0, 10) + '...' + STAKING_CONTRACT.slice(-8)
                },
                executeExitAll
            );
        }

        async function executeExitAll() {
            console.log('[Exit] executeExitAll called');
            const btn = document.getElementById('exitBtn');
            const originalText = btn.textContent;

            try {
                if (connectionType === 'extension') {
                    console.log('[Exit] Re-initializing contracts with signer...');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
                } else {
                    alert('Please connect with MetaMask browser extension to exit.');
                    return;
                }

                btn.textContent = 'Exiting...';
                console.log('[Exit] Calling exit...');
                const tx = await stakingContract.exit();
                console.log('[Exit] Tx sent:', tx.hash);
                await tx.wait();
                console.log('[Exit] Confirmed!');

                btn.textContent = 'Exited! ‚úì';
                await updateUI();

                setTimeout(() => { btn.textContent = originalText; }, 2000);

            } catch (error) {
                console.error('[Exit] Error:', error);
                btn.textContent = originalText;
                alert('Exit failed: ' + (error.reason || error.message));
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async (accounts) => {
                console.log('[Event] Accounts changed:', accounts);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    currentAccount = accounts[0];
                    connectionType = 'extension';
                    await initContracts();
                    await updateUI();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('[Event] Chain changed:', chainId);
                checkNetwork();
                updateUI();
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        console.log('[Init] BAI Staking page loaded');
        
        // Fetch public stats immediately on page load
        fetchPublicStats();

        // Check if already connected
        if (window.ethereum) {
            window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                if (accounts && accounts.length > 0) {
                    console.log('[Init] Found existing connection:', accounts[0]);
                    currentAccount = accounts[0];
                    connectionType = 'extension';
                    initContracts().then(() => updateUI());
                }
            }).catch(err => {
                console.log('[Init] No existing connection');
            });
        }
    </script>
</body>
</html>