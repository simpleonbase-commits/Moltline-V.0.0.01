<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíé Diamond Hands Staking - Bureau of Agent Investigations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 1px solid #1a1a2e;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .tagline {
            color: #888;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #ffa500;
            font-size: 1.3rem;
            font-weight: bold;
            font-style: italic;
        }
        
        /* Connect Wallet */
        .connect-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .connect-btn {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.4);
        }

        .connect-btn:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .wallet-info {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 15px 25px;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .wallet-address {
            font-family: monospace;
            color: #4ade80;
        }

        .disconnect-btn {
            background: #2a2a3e;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: #ff6b6b;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .disconnect-btn:hover {
            background: #3a3a4e;
        }

        /* Wallet Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #12121a;
            border: 1px solid #2a2a3e;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #fff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .modal-close:hover {
            color: #fff;
        }

        .wallet-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wallet-option:hover {
            background: #252535;
            border-color: #ffa500;
        }

        .wallet-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wallet-option.disabled:hover {
            background: #1a1a2e;
            border-color: #2a2a3e;
        }

        .wallet-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .wallet-icon.metamask {
            background: linear-gradient(135deg, #f5841f, #e27625);
        }

        .wallet-icon.coinbase {
            background: #0052ff;
        }

        .wallet-icon.walletconnect {
            background: linear-gradient(135deg, #3b99fc, #2d7dd2);
        }

        .wallet-name {
            font-weight: 600;
            color: #fff;
        }

        .wallet-desc {
            font-size: 0.8rem;
            color: #888;
        }

        .wallet-status {
            margin-left: auto;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #2a4a2a;
            color: #4ade80;
        }

        .wallet-status.not-installed {
            background: #3a2a2a;
            color: #888;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .stat-card:hover {
            border-color: #333;
        }

        .stat-card.highlight {
            border-color: #ffa500;
            background: linear-gradient(135deg, #12121a 0%, #1a1510 100%);
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .stat-value.green {
            color: #4ade80;
        }

        .stat-value.orange {
            color: #ffa500;
        }

        .stat-value.red {
            color: #ff6b6b;
        }

        /* Main Staking Panel */
        .staking-panel {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1a1a2e;
        }

        .panel-title {
            font-size: 1.5rem;
            color: #fff;
        }

        .panel-badge {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 10px;
            color: #888;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #252535;
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            border-color: transparent;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Input Group */
        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #888;
            font-size: 0.9rem;
        }

        .balance-link {
            color: #ffa500;
            cursor: pointer;
            text-decoration: underline;
        }

        .input-wrapper {
            position: relative;
        }

        .amount-input {
            width: 100%;
            background: #0a0a0f;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 18px 100px 18px 18px;
            font-size: 1.3rem;
            color: #fff;
            outline: none;
            transition: border-color 0.3s;
        }

        .amount-input:focus {
            border-color: #ffa500;
        }

        .max-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #2a2a3e;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: #ffa500;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .max-btn:hover {
            background: #3a3a4e;
        }

        /* Action Buttons */
        .action-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
        }

        .action-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(255, 107, 107, 0.3);
        }

        .action-btn.secondary {
            background: #1a1a2e;
            color: #fff;
            border: 1px solid #2a2a3e;
        }

        .action-btn.secondary:hover {
            background: #252535;
        }

        .action-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Warning Box */
        .warning-box {
            background: linear-gradient(135deg, #2a1a1a 0%, #1a1210 100%);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .warning-box.locked {
            border-color: #ffa500;
            background: linear-gradient(135deg, #2a2010 0%, #1a1510 100%);
        }

        .warning-title {
            color: #ff6b6b;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-box.locked .warning-title {
            color: #ffa500;
        }

        .warning-text {
            color: #888;
            font-size: 0.9rem;
        }

        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #0a0a0f;
            border: 1px solid #1a1a2e;
            border-radius: 10px;
            padding: 15px;
        }

        .info-label {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Rewards Section */
        .rewards-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #0a150a 0%, #0a0a0f 100%);
            border: 1px solid #2a4a2a;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rewards-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 5px;
        }

        .rewards-label {
            color: #888;
        }

        /* Contract Info */
        .contract-info {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .contract-title {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .contract-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .contract-link {
            color: #ffa500;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.85rem;
            padding: 8px 15px;
            background: #0a0a0f;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .contract-link:hover {
            background: #1a1a2e;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 1px solid #1a1a2e;
            margin-top: 40px;
            color: #666;
        }

        footer a {
            color: #ffa500;
            text-decoration: none;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top-color: #ffa500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Network Warning */
        .network-warning {
            background: linear-gradient(135deg, #2a1a1a 0%, #1a1210 100%);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .network-warning button {
            background: #ff6b6b;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }

            .contract-links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üíé</div>
            <h1>Diamond Hands Staking</h1>
            <p class="tagline">Bureau of Agent Investigations</p>
            <p class="subtitle">"Paper Hands Pay, Diamond Hands Gain"</p>
        </header>

        <!-- Connect Wallet -->
        <div class="connect-section">
            <button class="connect-btn" id="connectBtn" onclick="openWalletModal()">
                üîó Connect Wallet
            </button>
            <div class="wallet-info" id="walletInfo" style="display: none;">
                <span>Connected: <span class="wallet-address" id="walletAddress"></span></span>
                <button class="disconnect-btn" onclick="disconnectWallet()">Disconnect</button>
            </div>
        </div>

        <!-- Network Warning -->
        <div class="network-warning" id="networkWarning" style="display: none;">
            <div>‚ö†Ô∏è Wrong Network - Please switch to Base</div>
            <button onclick="switchToBase()">Switch to Base</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Staked</div>
                <div class="stat-value" id="totalStaked">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Your Stake</div>
                <div class="stat-value orange" id="yourStake">--</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Your Rewards</div>
                <div class="stat-value green" id="yourRewards">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lock Status</div>
                <div class="stat-value" id="lockStatus">--</div>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="staking-panel">
            <div class="panel-header">
                <h2 class="panel-title">Stake BAItest</h2>
                <span class="panel-badge">20% Early Exit Penalty</span>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('stake', this)">Stake</button>
                <button class="tab-btn" onclick="showTab('unstake', this)">Unstake</button>
                <button class="tab-btn" onclick="showTab('rewards', this)">Rewards</button>
            </div>

            <!-- Stake Tab -->
            <div class="tab-content active" id="stakeTab">
                <div class="input-group">
                    <div class="input-label">
                        <span>Amount to Stake</span>
                        <span class="balance-link" onclick="setMaxStake()">Balance: <span id="walletBalance">--</span> BAItest</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" class="amount-input" id="stakeAmount" placeholder="0.0" step="any">
                        <button class="max-btn" onclick="setMaxStake()">MAX</button>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">Lock Period</div>
                        <div class="info-value">7 Days</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Early Penalty</div>
                        <div class="info-value">20%</div>
                    </div>
                </div>

                <button class="action-btn secondary" id="approveBtn" onclick="approveTokens()" style="display: none;">
                    Approve BAItest
                </button>
                <button class="action-btn primary" id="stakeBtn" onclick="stakeTokens()" disabled>
                    Connect Wallet to Stake
                </button>
            </div>

            <!-- Unstake Tab -->
            <div class="tab-content" id="unstakeTab">
                <div id="unstakeWarning" class="warning-box locked" style="display: none;">
                    <div class="warning-title">‚è≥ Tokens Locked</div>
                    <div class="warning-text">Your tokens unlock in <span id="unlockCountdown">--</span>. Early unstaking incurs a 20% penalty.</div>
                </div>

                <div id="earlyWarning" class="warning-box" style="display: none;">
                    <div class="warning-title">‚ö†Ô∏è Early Unstake Warning</div>
                    <div class="warning-text">You will lose <span id="penaltyAmount">--</span> BAItest (20%) which goes to remaining stakers.</div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>Amount to Unstake</span>
                        <span class="balance-link" onclick="setMaxUnstake()">Staked: <span id="stakedBalance">--</span> BAItest</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" class="amount-input" id="unstakeAmount" placeholder="0.0" step="any" oninput="updatePenaltyPreview()">
                        <button class="max-btn" onclick="setMaxUnstake()">MAX</button>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">You'll Receive</div>
                        <div class="info-value" id="receiveAmount">-- BAItest</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Penalty</div>
                        <div class="info-value" id="penaltyPreview">-- BAItest</div>
                    </div>
                </div>

                <button class="action-btn primary" id="unstakeBtn" onclick="unstakeTokens()" disabled>
                    Connect Wallet to Unstake
                </button>
            </div>

            <!-- Rewards Tab -->
            <div class="tab-content" id="rewardsTab">
                <div class="rewards-display">
                    <div class="rewards-amount" id="claimableRewards">0.00</div>
                    <div class="rewards-label">BAItest Available to Claim</div>
                </div>

                <p style="text-align: center; color: #888; margin-bottom: 20px;">
                    Rewards come from penalties paid by paper hands who unstake early.
                    The longer you stay, the more you earn! üíéüôå
                </p>

                <button class="action-btn primary" id="claimBtn" onclick="claimRewards()" disabled>
                    Connect Wallet to Claim
                </button>

                <button class="action-btn secondary" onclick="exitAll()" style="margin-top: 10px;" id="exitBtn" disabled>
                    üö™ Exit All (Unstake + Claim)
                </button>
            </div>
        </div>

        <!-- Contract Info -->
        <div class="contract-info">
            <div class="contract-title">Verified Contracts</div>
            <div class="contract-links">
                <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank" class="contract-link">
                    üìú Staking: 0x4b5b...c3Cc
                </a>
                <a href="https://basescan.org/address/0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3" target="_blank" class="contract-link">
                    ü™ô BAItest: 0x2ca8...5ba3
                </a>
            </div>
        </div>

        <footer>
            <p>Part of the <a href="index.html">Bureau of Agent Investigations</a> ecosystem</p>
            <p style="margin-top: 10px; font-size: 0.85rem;">Smart contract is immutable and fully verified. DYOR.</p>
        </footer>
    </div>

    <!-- Wallet Modal -->
    <div class="modal-overlay" id="walletModal" onclick="closeWalletModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Connect Wallet</h3>
                <button class="modal-close" onclick="closeWalletModal()">&times;</button>
            </div>
            <div class="wallet-options">
                <div class="wallet-option" id="metamaskOption" onclick="connectMetaMask()">
                    <div class="wallet-icon metamask">ü¶ä</div>
                    <div>
                        <div class="wallet-name">MetaMask</div>
                        <div class="wallet-desc">Connect using browser extension</div>
                    </div>
                    <span class="wallet-status" id="metamaskStatus">Checking...</span>
                </div>
                <div class="wallet-option" id="coinbaseOption" onclick="connectCoinbase()">
                    <div class="wallet-icon coinbase">üü¶</div>
                    <div>
                        <div class="wallet-name">Coinbase Wallet</div>
                        <div class="wallet-desc">Connect using Coinbase</div>
                    </div>
                    <span class="wallet-status" id="coinbaseStatus">Checking...</span>
                </div>
                <div class="wallet-option" onclick="connectWalletConnect()">
                    <div class="wallet-icon walletconnect">üì±</div>
                    <div>
                        <div class="wallet-name">WalletConnect</div>
                        <div class="wallet-desc">Scan QR code with mobile wallet</div>
                    </div>
                    <span class="wallet-status">Available</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
    
    <!-- WalletConnect -->
    <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.0/dist/index.umd.js"></script>
    
    <script>
        // Contract addresses
        const STAKING_ADDRESS = '0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc';
        const TOKEN_ADDRESS = '0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3';
        const BASE_CHAIN_ID = 8453;
        const WALLETCONNECT_PROJECT_ID = '286e939deb1fd152d44312f068de95da';

        // ABIs
        const STAKING_ABI = [
            'function stake(uint256 amount) external',
            'function unstake(uint256 amount) external',
            'function claimRewards() external',
            'function exit() external',
            'function totalStaked() view returns (uint256)',
            'function stakes(address) view returns (uint256 amount, uint256 stakedAt, uint256 rewardPerTokenPaid, uint256 pendingRewards)',
            'function earned(address account) view returns (uint256)',
            'function isUnlocked(address account) view returns (bool)',
            'function unlockTime(address account) view returns (uint256)',
            'function calculatePenalty(uint256 amount) view returns (uint256)',
            'function lockPeriod() view returns (uint256)',
            'function penaltyBps() view returns (uint256)'
        ];

        const ERC20_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function symbol() view returns (string)'
        ];

        // Global state
        let provider = null;
        let signer = null;
        let userAddress = null;
        let stakingContract = null;
        let tokenContract = null;
        let tokenDecimals = 18;
        let userStakeAmount = 0n;
        let userUnlocked = true;
        let userUnlockTime = 0;
        let walletConnectProvider = null;

        // Check wallet availability on load
        window.addEventListener('load', () => {
            checkWalletAvailability();
        });

        function checkWalletAvailability() {
            // MetaMask
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                document.getElementById('metamaskStatus').textContent = 'Installed';
                document.getElementById('metamaskOption').classList.remove('disabled');
            } else {
                document.getElementById('metamaskStatus').textContent = 'Not Installed';
                document.getElementById('metamaskStatus').classList.add('not-installed');
            }

            // Coinbase
            if (typeof window.ethereum !== 'undefined' && (window.ethereum.isCoinbaseWallet || window.ethereum.providers?.some(p => p.isCoinbaseWallet))) {
                document.getElementById('coinbaseStatus').textContent = 'Installed';
                document.getElementById('coinbaseOption').classList.remove('disabled');
            } else {
                document.getElementById('coinbaseStatus').textContent = 'Not Installed';
                document.getElementById('coinbaseStatus').classList.add('not-installed');
            }
        }

        // Modal functions
        function openWalletModal() {
            document.getElementById('walletModal').classList.add('active');
        }

        function closeWalletModal(event) {
            if (!event || event.target === document.getElementById('walletModal')) {
                document.getElementById('walletModal').classList.remove('active');
            }
        }

        // Connect MetaMask
        async function connectMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                // Find MetaMask provider
                let eth = window.ethereum;
                if (window.ethereum.providers) {
                    eth = window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum;
                }

                const accounts = await eth.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(eth);
                signer = await provider.getSigner();
                userAddress = accounts[0];

                await onConnected();
                closeWalletModal();

                // Listen for account changes
                eth.on('accountsChanged', handleAccountsChanged);
                eth.on('chainChanged', () => window.location.reload());

            } catch (error) {
                console.error('MetaMask connection error:', error);
                alert('Failed to connect: ' + (error.message || error));
            }
        }

        // Connect Coinbase Wallet
        async function connectCoinbase() {
            if (typeof window.ethereum === 'undefined') {
                window.open('https://www.coinbase.com/wallet', '_blank');
                return;
            }

            try {
                let eth = window.ethereum;
                if (window.ethereum.providers) {
                    eth = window.ethereum.providers.find(p => p.isCoinbaseWallet) || window.ethereum;
                }

                const accounts = await eth.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(eth);
                signer = await provider.getSigner();
                userAddress = accounts[0];

                await onConnected();
                closeWalletModal();

                eth.on('accountsChanged', handleAccountsChanged);
                eth.on('chainChanged', () => window.location.reload());

            } catch (error) {
                console.error('Coinbase connection error:', error);
                alert('Failed to connect: ' + (error.message || error));
            }
        }

        // Connect WalletConnect
        async function connectWalletConnect() {
            try {
                const WalletConnectProvider = window.EthereumProvider.EthereumProvider;
                
                walletConnectProvider = await WalletConnectProvider.init({
                    projectId: WALLETCONNECT_PROJECT_ID,
                    chains: [BASE_CHAIN_ID],
                    showQrModal: true,
                    metadata: {
                        name: 'BAI Diamond Hands Staking',
                        description: 'Paper Hands Pay, Diamond Hands Gain',
                        url: 'https://simpleonbase-commits.github.io/BAI-V.0.0.01/',
                        icons: ['https://simpleonbase-commits.github.io/BAI-V.0.0.01/favicon.ico']
                    }
                });

                await walletConnectProvider.connect();
                
                provider = new ethers.BrowserProvider(walletConnectProvider);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                await onConnected();
                closeWalletModal();

                walletConnectProvider.on('accountsChanged', handleAccountsChanged);
                walletConnectProvider.on('chainChanged', () => window.location.reload());
                walletConnectProvider.on('disconnect', disconnectWallet);

            } catch (error) {
                console.error('WalletConnect error:', error);
                if (error.message !== 'User rejected the request.') {
                    alert('Failed to connect: ' + (error.message || error));
                }
            }
        }

        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                userAddress = accounts[0];
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                refreshData();
            }
        }

        // On connected
        async function onConnected() {
            // Update UI
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('walletInfo').style.display = 'inline-flex';
            document.getElementById('walletAddress').textContent = 
                userAddress.slice(0, 6) + '...' + userAddress.slice(-4);

            // Enable buttons
            document.getElementById('stakeBtn').disabled = false;
            document.getElementById('stakeBtn').textContent = 'üíé Stake BAItest';
            document.getElementById('unstakeBtn').disabled = false;
            document.getElementById('unstakeBtn').textContent = 'üì§ Unstake';
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('claimBtn').textContent = 'üéÅ Claim Rewards';
            document.getElementById('exitBtn').disabled = false;

            // Check network
            const network = await provider.getNetwork();
            if (Number(network.chainId) !== BASE_CHAIN_ID) {
                document.getElementById('networkWarning').style.display = 'block';
            } else {
                document.getElementById('networkWarning').style.display = 'none';
            }

            // Setup contracts
            stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
            tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);

            // Refresh data
            await refreshData();
        }

        // Disconnect
        function disconnectWallet() {
            if (walletConnectProvider) {
                walletConnectProvider.disconnect();
                walletConnectProvider = null;
            }
            
            provider = null;
            signer = null;
            userAddress = null;
            stakingContract = null;
            tokenContract = null;

            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('networkWarning').style.display = 'none';
            document.getElementById('stakeBtn').disabled = true;
            document.getElementById('stakeBtn').textContent = 'Connect Wallet to Stake';
            document.getElementById('unstakeBtn').disabled = true;
            document.getElementById('unstakeBtn').textContent = 'Connect Wallet to Unstake';
            document.getElementById('claimBtn').disabled = true;
            document.getElementById('claimBtn').textContent = 'Connect Wallet to Claim';
            document.getElementById('exitBtn').disabled = true;
        }

        // Switch to Base network
        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2105' }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x2105',
                            chainName: 'Base',
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                            rpcUrls: ['https://mainnet.base.org'],
                            blockExplorerUrls: ['https://basescan.org']
                        }]
                    });
                }
            }
        }

        // Tab switching
        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            btn.classList.add('active');
        }

        // Refresh all data
        async function refreshData() {
            if (!stakingContract || !tokenContract || !userAddress) return;
            
            try {
                tokenDecimals = Number(await tokenContract.decimals());

                const total = await stakingContract.totalStaked();
                document.getElementById('totalStaked').textContent = formatAmount(total) + ' BAItest';

                const balance = await tokenContract.balanceOf(userAddress);
                document.getElementById('walletBalance').textContent = formatAmount(balance);

                const stakeInfo = await stakingContract.stakes(userAddress);
                userStakeAmount = stakeInfo[0];
                document.getElementById('yourStake').textContent = formatAmount(userStakeAmount) + ' BAItest';
                document.getElementById('stakedBalance').textContent = formatAmount(userStakeAmount);

                const rewards = await stakingContract.earned(userAddress);
                document.getElementById('yourRewards').textContent = formatAmount(rewards) + ' BAItest';
                document.getElementById('claimableRewards').textContent = formatAmount(rewards);

                userUnlocked = await stakingContract.isUnlocked(userAddress);
                userUnlockTime = Number(await stakingContract.unlockTime(userAddress));
                
                if (userStakeAmount == 0n) {
                    document.getElementById('lockStatus').textContent = 'No Stake';
                    document.getElementById('lockStatus').className = 'stat-value';
                    document.getElementById('unstakeWarning').style.display = 'none';
                    document.getElementById('earlyWarning').style.display = 'none';
                } else if (userUnlocked) {
                    document.getElementById('lockStatus').textContent = '‚úÖ Unlocked';
                    document.getElementById('lockStatus').className = 'stat-value green';
                    document.getElementById('unstakeWarning').style.display = 'none';
                    document.getElementById('earlyWarning').style.display = 'none';
                } else {
                    document.getElementById('lockStatus').textContent = 'üîí Locked';
                    document.getElementById('lockStatus').className = 'stat-value orange';
                    document.getElementById('unstakeWarning').style.display = 'block';
                    document.getElementById('earlyWarning').style.display = 'block';
                    updateCountdown();
                }

                await checkAllowance();

            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        async function checkAllowance() {
            if (!tokenContract || !userAddress) return;
            const allowance = await tokenContract.allowance(userAddress, STAKING_ADDRESS);
            const balance = await tokenContract.balanceOf(userAddress);
            
            if (allowance < balance && balance > 0n) {
                document.getElementById('approveBtn').style.display = 'block';
            } else {
                document.getElementById('approveBtn').style.display = 'none';
            }
        }

        function formatAmount(amount) {
            const formatted = ethers.formatUnits(amount, tokenDecimals);
            const num = parseFloat(formatted);
            if (num === 0) return '0';
            if (num < 0.01) return '<0.01';
            return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function updateCountdown() {
            const now = Math.floor(Date.now() / 1000);
            const remaining = userUnlockTime - now;
            
            if (remaining <= 0) {
                document.getElementById('unlockCountdown').textContent = 'now';
                return;
            }

            const days = Math.floor(remaining / 86400);
            const hours = Math.floor((remaining % 86400) / 3600);
            const mins = Math.floor((remaining % 3600) / 60);

            let text = '';
            if (days > 0) text += days + 'd ';
            if (hours > 0) text += hours + 'h ';
            text += mins + 'm';

            document.getElementById('unlockCountdown').textContent = text;
        }

        function updatePenaltyPreview() {
            const amount = document.getElementById('unstakeAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                document.getElementById('penaltyPreview').textContent = '-- BAItest';
                document.getElementById('receiveAmount').textContent = '-- BAItest';
                return;
            }

            const amountNum = parseFloat(amount);
            if (userUnlocked) {
                document.getElementById('penaltyPreview').textContent = '0 BAItest';
                document.getElementById('receiveAmount').textContent = amountNum.toFixed(2) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = '0';
            } else {
                const penalty = amountNum * 0.20;
                const receive = amountNum - penalty;
                document.getElementById('penaltyPreview').textContent = penalty.toFixed(2) + ' BAItest';
                document.getElementById('receiveAmount').textContent = receive.toFixed(2) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = penalty.toFixed(2);
            }
        }

        async function setMaxStake() {
            if (!tokenContract || !userAddress) return;
            const balance = await tokenContract.balanceOf(userAddress);
            document.getElementById('stakeAmount').value = ethers.formatUnits(balance, tokenDecimals);
        }

        function setMaxUnstake() {
            document.getElementById('unstakeAmount').value = ethers.formatUnits(userStakeAmount, tokenDecimals);
            updatePenaltyPreview();
        }

        async function approveTokens() {
            try {
                const btn = document.getElementById('approveBtn');
                btn.innerHTML = '<span class="spinner"></span>Approving...';
                btn.disabled = true;

                const tx = await tokenContract.approve(STAKING_ADDRESS, ethers.MaxUint256);
                await tx.wait();

                btn.style.display = 'none';
                alert('‚úÖ Approval successful!');
                await refreshData();

            } catch (error) {
                console.error('Approve error:', error);
                alert('Approval failed: ' + (error.reason || error.message));
                const btn = document.getElementById('approveBtn');
                btn.innerHTML = 'Approve BAItest';
                btn.disabled = false;
            }
        }

        async function stakeTokens() {
            try {
                const amount = document.getElementById('stakeAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    alert('Please enter an amount');
                    return;
                }

                const btn = document.getElementById('stakeBtn');
                btn.innerHTML = '<span class="spinner"></span>Staking...';
                btn.disabled = true;

                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                const tx = await stakingContract.stake(amountWei);
                await tx.wait();

                alert('‚úÖ Staked ' + amount + ' BAItest! Your tokens are now locked for 7 days.');
                document.getElementById('stakeAmount').value = '';
                await refreshData();

            } catch (error) {
                console.error('Stake error:', error);
                alert('Staking failed: ' + (error.reason || error.message));
            } finally {
                document.getElementById('stakeBtn').innerHTML = 'üíé Stake BAItest';
                document.getElementById('stakeBtn').disabled = false;
            }
        }

        async function unstakeTokens() {
            try {
                const amount = document.getElementById('unstakeAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    alert('Please enter an amount');
                    return;
                }

                if (!userUnlocked) {
                    const penalty = (parseFloat(amount) * 0.20).toFixed(2);
                    if (!confirm(`‚ö†Ô∏è Early unstake warning!\n\nYou will lose ${penalty} BAItest (20% penalty) which will be distributed to remaining stakers.\n\nProceed anyway?`)) {
                        return;
                    }
                }

                const btn = document.getElementById('unstakeBtn');
                btn.innerHTML = '<span class="spinner"></span>Unstaking...';
                btn.disabled = true;

                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                const tx = await stakingContract.unstake(amountWei);
                await tx.wait();

                alert('‚úÖ Unstaked successfully!');
                document.getElementById('unstakeAmount').value = '';
                await refreshData();

            } catch (error) {
                console.error('Unstake error:', error);
                alert('Unstaking failed: ' + (error.reason || error.message));
            } finally {
                document.getElementById('unstakeBtn').innerHTML = 'üì§ Unstake';
                document.getElementById('unstakeBtn').disabled = false;
            }
        }

        async function claimRewards() {
            try {
                const btn = document.getElementById('claimBtn');
                btn.innerHTML = '<span class="spinner"></span>Claiming...';
                btn.disabled = true;

                const tx = await stakingContract.claimRewards();
                await tx.wait();

                alert('‚úÖ Rewards claimed!');
                await refreshData();

            } catch (error) {
                console.error('Claim error:', error);
                alert('Claim failed: ' + (error.reason || error.message));
            } finally {
                document.getElementById('claimBtn').innerHTML = 'üéÅ Claim Rewards';
                document.getElementById('claimBtn').disabled = false;
            }
        }

        async function exitAll() {
            try {
                if (!userUnlocked && userStakeAmount > 0n) {
                    const penaltyAmount = userStakeAmount * 20n / 100n;
                    const penalty = formatAmount(penaltyAmount);
                    if (!confirm(`‚ö†Ô∏è Early exit warning!\n\nYou will lose approximately ${penalty} BAItest (20% penalty).\n\nProceed anyway?`)) {
                        return;
                    }
                }

                const btn = document.getElementById('exitBtn');
                btn.innerHTML = '<span class="spinner"></span>Exiting...';
                btn.disabled = true;

                const tx = await stakingContract.exit();
                await tx.wait();

                alert('‚úÖ Exited! All tokens and rewards withdrawn.');
                await refreshData();

            } catch (error) {
                console.error('Exit error:', error);
                alert('Exit failed: ' + (error.reason || error.message));
            } finally {
                document.getElementById('exitBtn').innerHTML = 'üö™ Exit All (Unstake + Claim)';
                document.getElementById('exitBtn').disabled = false;
            }
        }

        setInterval(updateCountdown, 60000);
    </script>
</body>
</html>